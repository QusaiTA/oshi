<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PerfCounterQuery.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">oshi-core</a> &gt; <a href="index.source.html" class="el_package">oshi.data.windows</a> &gt; <span class="el_source">PerfCounterQuery.java</span></div><h1>PerfCounterQuery.java</h1><pre class="source lang-java linenums">/**
 * MIT License
 *
 * Copyright (c) 2010 - 2020 The OSHI Project Contributors:
 * https://github.com/oshi/oshi/graphs/contributors
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
package oshi.data.windows;

import java.util.EnumMap;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.sun.jna.platform.win32.Variant; //NOSONAR
import com.sun.jna.platform.win32.COM.WbemcliUtil.WmiQuery;
import com.sun.jna.platform.win32.COM.WbemcliUtil.WmiResult;

import oshi.util.platform.windows.PerfDataUtil;
import oshi.util.platform.windows.PerfDataUtil.PerfCounter;
import oshi.util.platform.windows.WmiQueryHandler;
import oshi.util.platform.windows.WmiUtil;

public class PerfCounterQuery&lt;T extends Enum&lt;T&gt;&gt; {

<span class="nc" id="L43">    private static final Logger LOG = LoggerFactory.getLogger(PerfCounter.class);</span>

    /*
     * Set on instantiation
     */
    protected final Class&lt;T&gt; propertyEnum;
    protected final String perfObject;
    protected final String perfWmiClass;
    protected final String queryKey;
    protected CounterDataSource source;
    protected PerfCounterQueryHandler pdhQueryHandler;
    protected WmiQueryHandler wmiQueryHandler;
    /*
     * Only one will be non-null depending on source
     */
<span class="nc" id="L58">    private EnumMap&lt;T, PerfCounter&gt; counterMap = null;</span>
<span class="nc" id="L59">    protected WmiQuery&lt;T&gt; counterQuery = null;</span>

    /*
     * Multiple classes use these constants
     */
    public static final String TOTAL_INSTANCE = &quot;_Total&quot;;
    public static final String NOT_TOTAL_INSTANCE = &quot;^&quot; + TOTAL_INSTANCE;

    /**
     * Construct a new object to hold performance counter data source and results
     * 
     * @param propertyEnum
     *            An enum which implements {@link PdhCounterProperty} and contains
     *            the WMI field (Enum value) and PDH Counter string (instance and
     *            counter)
     * @param perfObject
     *            The PDH object for this counter; all counters on this object will
     *            be refreshed at the same time
     * @param perfWmiClass
     *            The WMI PerfData_RawData_* class corresponding to the PDH object
     */
    public PerfCounterQuery(Class&lt;T&gt; propertyEnum, String perfObject, String perfWmiClass) {
<span class="nc" id="L81">        this(propertyEnum, perfObject, perfWmiClass, perfObject);</span>
<span class="nc" id="L82">    }</span>

    /**
     * Construct a new object to hold performance counter data source and results
     * 
     * @param propertyEnum
     *            An enum which implements {@link PdhCounterProperty} and contains
     *            the WMI field (Enum value) and PDH Counter string (instance and
     *            counter)
     * @param perfObject
     *            The PDH object for this counter; all counters on this object will
     *            be refreshed at the same time
     * @param perfWmiClass
     *            The WMI PerfData_RawData_* class corresponding to the PDH object
     * @param queryKey
     *            An optional key for PDH counter updates; defaults to the PDH
     *            object name
     */
<span class="nc" id="L100">    public PerfCounterQuery(Class&lt;T&gt; propertyEnum, String perfObject, String perfWmiClass, String queryKey) {</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        if (PdhCounterProperty.class.isAssignableFrom(propertyEnum.getDeclaringClass())) {</span>
<span class="nc" id="L102">            throw new IllegalArgumentException(</span>
<span class="nc" id="L103">                    propertyEnum.getDeclaringClass().getName() + &quot; must implement PdhCounterProperty.&quot;);</span>
        }
<span class="nc" id="L105">        this.propertyEnum = propertyEnum;</span>
<span class="nc" id="L106">        this.perfObject = perfObject;</span>
<span class="nc" id="L107">        this.perfWmiClass = perfWmiClass;</span>
<span class="nc" id="L108">        this.queryKey = queryKey;</span>
<span class="nc" id="L109">        this.pdhQueryHandler = PerfCounterQueryHandler.getInstance();</span>
<span class="nc" id="L110">        this.wmiQueryHandler = WmiQueryHandler.createInstance();</span>
        // Start off with PDH as source; if query here fails we will permanently
        // fall back to WMI
<span class="nc" id="L113">        this.source = CounterDataSource.PDH;</span>
<span class="nc" id="L114">    }</span>

    /**
     * Set the Data Source for these counters
     * 
     * @param source
     *            The source of data
     * @return Whether the data source was successfully set
     */
    public boolean setDataSource(CounterDataSource source) {
<span class="nc" id="L124">        this.source = source;</span>
<span class="nc bnc" id="L125" title="All 3 branches missed.">        switch (source) {</span>
        case PDH:
<span class="nc" id="L127">            LOG.debug(&quot;Attempting to set PDH Data Source.&quot;);</span>
<span class="nc" id="L128">            unInitWmiCounters();</span>
<span class="nc" id="L129">            return initPdhCounters();</span>
        case WMI:
<span class="nc" id="L131">            LOG.debug(&quot;Attempting to set WMI Data Source.&quot;);</span>
<span class="nc" id="L132">            unInitPdhCounters();</span>
<span class="nc" id="L133">            initWmiCounters();</span>
<span class="nc" id="L134">            return true;</span>
        default:
            // This should never happen unless you've added a new source and
            // forgot to add a case for it
<span class="nc" id="L138">            throw new IllegalArgumentException(&quot;Invalid Data Source specified.&quot;);</span>
        }
    }

    /**
     * Initialize PDH counters for this data source. Adds necessary counters to a
     * PDH Query.
     * 
     * @return True if the counters were successfully added.
     */
    protected boolean initPdhCounters() {
<span class="nc" id="L149">        this.counterMap = new EnumMap&lt;T, PerfCounter&gt;(propertyEnum);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        for (T prop : propertyEnum.getEnumConstants()) {</span>
<span class="nc" id="L151">            PerfCounter counter = PerfDataUtil.createCounter(perfObject, ((PdhCounterProperty) prop).getInstance(),</span>
<span class="nc" id="L152">                    ((PdhCounterProperty) prop).getCounter());</span>
<span class="nc" id="L153">            counterMap.put(prop, counter);</span>
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (!pdhQueryHandler.addCounterToQuery(counter, this.queryKey)) {</span>
<span class="nc" id="L155">                unInitPdhCounters();</span>
<span class="nc" id="L156">                return false;</span>
            }
        }
<span class="nc" id="L159">        return true;</span>
    }

    /**
     * Uninitialize PDH counters for this data source. Removes necessary counters
     * from the PDH Query, releasing their handles.
     */
    protected void unInitPdhCounters() {
<span class="nc" id="L167">        pdhQueryHandler.removeAllCountersFromQuery(this.queryKey);</span>
<span class="nc" id="L168">        this.counterMap = null;</span>
<span class="nc" id="L169">    }</span>

    /**
     * Initialize the WMI query object needed to retrieve counters for this data
     * source.
     */
    protected void initWmiCounters() {
<span class="nc" id="L176">        this.counterQuery = new WmiQuery&lt;T&gt;(perfWmiClass, propertyEnum);</span>
<span class="nc" id="L177">    }</span>

    /**
     * Uninitializes the WMI query object needed to retrieve counters for this data
     * source, allowing it to be garbage collected.
     */
    protected void unInitWmiCounters() {
<span class="nc" id="L184">        this.counterQuery = null;</span>
<span class="nc" id="L185">    }</span>

    /**
     * Query the current data source (PDH or WMI) for the Performance Counter values
     * corresponding to the property enum.
     * 
     * @return A map of the values by the counter enum.
     */
    public Map&lt;T, Long&gt; queryValues() {
<span class="nc" id="L194">        EnumMap&lt;T, Long&gt; valueMap = new EnumMap&lt;T, Long&gt;(propertyEnum);</span>
<span class="nc" id="L195">        T[] props = this.propertyEnum.getEnumConstants();</span>
<span class="nc bnc" id="L196" title="All 2 branches missed.">        if (source.equals(CounterDataSource.PDH)) {</span>
            // Set up the query and counter handles, and query
<span class="nc bnc" id="L198" title="All 4 branches missed.">            if (initPdhCounters() &amp;&amp; queryPdh(valueMap, props)) {</span>
                // If both init and query return true, then valueMap contains
                // the results. Release the handles.
<span class="nc" id="L201">                unInitPdhCounters();</span>
            } else {
                // If either init or query failed, switch to WMI
<span class="nc" id="L204">                setDataSource(CounterDataSource.WMI);</span>
            }
        }
<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (source.equals(CounterDataSource.WMI)) {</span>
<span class="nc" id="L208">            queryWmi(valueMap, props);</span>
        }
<span class="nc" id="L210">        return valueMap;</span>
    }

    private boolean queryPdh(Map&lt;T, Long&gt; valueMap, T[] props) {
<span class="nc bnc" id="L214" title="All 4 branches missed.">        if (counterMap != null &amp;&amp; 0 &lt; pdhQueryHandler.updateQuery(this.queryKey)) {</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">            for (T prop : props) {</span>
<span class="nc" id="L216">                valueMap.put(prop, pdhQueryHandler.queryCounter(counterMap.get(prop)));</span>
            }
<span class="nc" id="L218">            return true;</span>
        }
        // Zero timestamp means update failed after muliple
        // attempts; fallback to WMI
<span class="nc" id="L222">        return false;</span>
    }

    private void queryWmi(Map&lt;T, Long&gt; valueMap, T[] props) {
<span class="nc" id="L226">        WmiResult&lt;T&gt; result = wmiQueryHandler.queryWMI(this.counterQuery);</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (result.getResultCount() &gt; 0) {</span>
<span class="nc bnc" id="L228" title="All 2 branches missed.">            for (T prop : props) {</span>
<span class="nc bnc" id="L229" title="All 4 branches missed.">                switch (result.getVtType(prop)) {</span>
                case Variant.VT_I2:
<span class="nc" id="L231">                    valueMap.put(prop, Long.valueOf(WmiUtil.getUint16(result, prop, 0)));</span>
<span class="nc" id="L232">                    break;</span>
                case Variant.VT_I4:
<span class="nc" id="L234">                    valueMap.put(prop, WmiUtil.getUint32asLong(result, prop, 0));</span>
<span class="nc" id="L235">                    break;</span>
                case Variant.VT_BSTR:
<span class="nc" id="L237">                    valueMap.put(prop, WmiUtil.getUint64(result, prop, 0));</span>
<span class="nc" id="L238">                    break;</span>
                default:
<span class="nc" id="L240">                    throw new ClassCastException(&quot;Unimplemented VT Type Mapping.&quot;);</span>
                }
            }
        }
<span class="nc" id="L244">    }</span>

    /**
     * Source of performance counter data.
     */
<span class="nc" id="L249">    public enum CounterDataSource {</span>
        /**
         * Performance Counter data will be pulled from a PDH Counter
         */
<span class="nc" id="L253">        PDH,</span>
        /**
         * Performance Counter data will be pulled from a WMI PerfData_RawData_* table
         */
<span class="nc" id="L257">        WMI;</span>
    }

    /**
     * Contract for Counter Property Enums
     */
    public interface PdhCounterProperty {
        /**
         * @return Returns the instance.
         */
        String getInstance();

        /**
         * @return Returns the counter.
         */
        String getCounter();
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>